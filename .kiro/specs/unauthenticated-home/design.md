# デザインドキュメント

## 概要

未認証ホームページは、訪問者がサインアップする前にTechTokの縦スクロールフィードを体験できるプレビュー機能を提供します。このデザインは、ユーザーエンゲージメント（興味を引くのに十分なコンテンツを表示）とコンバージョン最適化（適切なタイミングでログインを促す）のバランスを取ります。認証済みユーザーは即座にフルフィード体験にリダイレクトされます。

## アーキテクチャ

### コンポーネント階層

```
ホームページ (/)
├── サーバーコンポーネント (page.tsx)
│   ├── セッションチェック (auth)
│   ├── 条件付きリダイレクトロジック
│   └── 初期データ取得（最初の3記事）
│
└── クライアントコンポーネント (unauthenticated-home.tsx)
    ├── VerticalScrollFeed（最初の3記事）
    ├── LoginPromptSlide（4番目の位置）
    └── PersistentLoginBanner（下部オーバーレイ）
```

### データフロー

1. **サーバーサイドセッションチェック**: better-authを使用して認証状態を確認
2. **条件付きレンダリング**:
   - 認証済み → `/feed`にリダイレクト
   - 未認証 → 3記事 + ログインプロンプトのプレビューをレンダリング
3. **クライアントサイドインタラクション**: スクロールイベントとログインプロンプト表示を処理

## コンポーネントとインターフェース

### 1. ホームページ（サーバーコンポーネント）

**ファイル**: `src/app/page.tsx`

**責務**:
- ユーザー認証状態の確認
- 認証済みユーザーを`/feed`にリダイレクト
- プレビュー用の最初の3記事を取得
- 未認証ホームクライアントコンポーネントをレンダリング

**インターフェース**:
```typescript
// サーバーコンポーネント - propsなし
export default async function Home(): Promise<JSX.Element>
```

**実装詳細**:
- `@/lib/auth`の`getSession()`を使用して認証を確認
- 認証済みユーザーには`next/navigation`の`redirect()`を使用
- `getFeedArticles({ limit: 3 })`を使用してプレビュー記事を取得
- 記事をクライアントコンポーネントに渡す

### 2. 未認証ホーム（クライアントコンポーネント）

**ファイル**: `src/features/feed/components/unauthenticated-home.tsx`

**責務**:
- 3記事の縦スクロールフィードを表示
- 4番目のスライドとしてログインプロンプトを表示
- 永続的なログインバナーを表示
- スクロールインタラクションを処理
- ログインプロンプトを超えるスクロールを防止

**インターフェース**:
```typescript
export interface UnauthenticatedHomeProps {
  /** プレビュー記事（3つに制限） */
  articles: Article[];
}

export function UnauthenticatedHome({ articles }: UnauthenticatedHomeProps): JSX.Element
```

**状態管理**:
```typescript
const [currentIndex, setCurrentIndex] = useState(0);
const [showLoginPrompt, setShowLoginPrompt] = useState(false);
```

**実装詳細**:
- 3記事 + 1ログインプロンプトスライドをフィードアイテムに結合
- 修正された`VerticalScrollFeed`コンポーネントを使用
- 現在のスライドインデックスを追跡
- インデックス3に到達したらログインプロンプトを表示
- ログインプロンプト後のさらなるスクロールを防止

### 3. ログインプロンプトスライド

**ファイル**: `src/features/feed/components/login-prompt-slide.tsx`

**責務**:
- ログインへの魅力的なコールトゥアクションを表示
- OAuthボタン（Google、GitHub）を提供
- サインインのメリットを説明
- 縦フィードスライドデザインに合わせる

**インターフェース**:
```typescript
export interface LoginPromptSlideProps {
  /** ログイン後のオプションのコールバックURL */
  callbackUrl?: string;
}

export function LoginPromptSlide({ callbackUrl = "/feed" }: LoginPromptSlideProps): JSX.Element
```

**デザイン要素**:
- フィードアイテムの寸法に合わせたフルスクリーンスライド
- ダークバックグラウンドの中央配置コンテンツカード
- 見出し: "もっと見たいですか？"
- サブ見出し: "ログインして全ての記事をお楽しみください"
- OAuthボタン（`OAuthButtons`コンポーネントを再利用）
- メリットリスト:
  - 無制限の記事閲覧
  - お気に入り機能
  - コメント機能
  - フォロー機能

### 4. 永続的ログインバナー

**ファイル**: `src/features/feed/components/persistent-login-banner.tsx`

**責務**:
- 控えめなログイン促進オーバーレイを表示
- 記事数情報を表示
- クイックログインボタンを提供
- 邪魔にならないデザイン

**インターフェース**:
```typescript
export interface PersistentLoginBannerProps {
  /** 現在の記事インデックス（0-2） */
  currentIndex: number;
  /** プレビュー記事の合計数 */
  totalPreview: number;
}

export function PersistentLoginBanner({ 
  currentIndex, 
  totalPreview 
}: PersistentLoginBannerProps): JSX.Element
```

**デザイン要素**:
- 画面下部の固定位置
- 半透明のダークバックグラウンド
- 進捗インジケーター: "記事 {currentIndex + 1} / {totalPreview}"
- 小さなログインボタン
- スクロール位置に基づくフェードイン/アウト

## データモデル

### 記事プレビューデータ

```typescript
// フィード機能の既存のArticle型を再利用
import type { Article } from "@/features/feed/types/article";

// プレビュー記事を取得するサーバーアクション
export async function getPreviewArticles(): Promise<Article[]> {
  return getFeedArticles({ limit: 3 }).then(result => result.articles);
}
```

### フィードアイテムユニオン型

```typescript
// フィードアイテムのユニオン型（記事またはログインプロンプト）
export type PreviewFeedItem = 
  | { type: "article"; data: Article }
  | { type: "login-prompt" };
```

## エラーハンドリング

### セッションチェックエラー

**シナリオ**: Auth.jsセッションチェックが失敗
**処理**: 
- エラーをコンソールにログ
- 未認証ユーザーとして扱う
- プレビュー体験を継続

### 記事取得エラー

**シナリオ**: プレビュー記事の取得に失敗
**処理**:
- 最初のスライドにエラーメッセージを表示
- リトライボタンを提供
- 代替アクションとしてログインプロンプトを表示

**エラーコンポーネント**:
```typescript
export function PreviewErrorState({ onRetry }: { onRetry: () => void }): JSX.Element
```

### リダイレクトエラー

**シナリオ**: `/feed`へのリダイレクトが失敗
**処理**:
- エラーをコンソールにログ
- フィードへの手動リンク付きエラーメッセージを表示
- フォールバックナビゲーションを提供

## テスト戦略

### ユニットテスト

**コンポーネントテスト**:
- `UnauthenticatedHome`: 3記事 + ログインプロンプトをレンダリング
- `LoginPromptSlide`: OAuthボタンとメリットを表示
- `PersistentLoginBanner`: 正しい進捗インジケーターを表示

**フックテスト**:
- スクロール動作がログインプロンプトで停止
- 現在のインデックスが正しく更新される

### 統合テスト

**認証フロー**:
- 認証済みユーザーが`/feed`にリダイレクト
- 未認証ユーザーがプレビューを表示
- プロンプトからのログインが`/feed`にリダイレクト

**スクロール動作**:
- 3記事をスクロール可能
- ログインプロンプト（4番目の位置）で停止
- ログインプロンプトを超えてスクロール不可

### E2Eテスト（オプション）

**ユーザージャーニー**:
1. 未認証ユーザーとしてホームページを訪問
2. 3記事をスクロール
3. 4番目の位置でログインプロンプトを表示
4. OAuthボタンをクリック
5. 認証を完了
6. フルフィードにリダイレクト

## デザイン決定と根拠

### 1. サーバーサイド認証チェック

**決定**: レンダリング前にサーバーで認証を確認
**根拠**: 
- ログイン済みユーザーに対する未認証コンテンツのフラッシュを防止
- 体感パフォーマンスの向上
- クライアントサイドJavaScript実行の削減

### 2. 3記事プレビュー制限

**決定**: ログインプロンプト前に正確に3記事を表示
**根拠**:
- 価値を示すのに十分なコンテンツ
- コンバージョンを減らさない程度の量
- 一般的なプレビューパターンに一致（例：Medium、Quora）
- 要件仕様に準拠

### 3. 4番目のスライドとしてのログインプロンプト

**決定**: ログインプロンプトをフィード内のスライドとして統合
**根拠**:
- 一貫した縦スクロールUXを維持
- ユーザーフローの自然な停止点
- モーダルオーバーレイよりも違和感が少ない
- エンゲージメントのピーク時にコンバージョンを促進

### 4. 永続的ログインバナー

**決定**: プレビュー全体を通して控えめなバナーを表示
**根拠**:
- ログインオプションの継続的なリマインダー
- コンテキスト（記事数）を提供
- 邪魔にならないデザインでコンテンツに集中を維持
- ログインへの素早いアクセスを提供

### 5. 既存コンポーネントの再利用

**決定**: `VerticalScrollFeed`、`OAuthButtons`、`Article`型を活用
**根拠**:
- デザインの一貫性を維持
- 開発時間の短縮
- 認証済みフィードと同じUXを保証
- メンテナンスの簡素化

### 6. ログインプロンプトからの戻りナビゲーションなし

**決定**: ログインプロンプトに到達後の上方向スクロールを防止
**根拠**:
- コンバージョン決定を促進
- スクロールロジックの簡素化
- 要件仕様に一致
- 必要に応じてブラウザの戻るボタンを使用可能

## パフォーマンスの考慮事項

### サーバーサイドレンダリング

- 初期ページロードはSSRを使用して高速な最初のコンテンツ表示
- セッションチェックはサーバーで実行（クライアントサイドの遅延なし）
- プレビュー記事はサーバーで取得（ローディング状態なし）

### データ取得

- 3記事のみを取得（最小限のデータベースクエリ）
- 追加記事のプリフェッチなし
- プレビュー用の無限スクロールロジックなし

### クライアントサイド最適化

- 記事内の画像を遅延読み込み
- JavaScriptバンドルサイズの最小化
- 既存のフィードコンポーネントを再利用（重複なし）

### キャッシング戦略

- プレビュー記事を5分間キャッシュ（stale-while-revalidate）
- セッションチェック結果をキャッシュ
- 認証済みリダイレクトのキャッシングなし

## アクセシビリティ

### キーボードナビゲーション

- 記事間のスクロールに矢印キーをサポート
- ログインプロンプトのフォーカス管理
- OAuthボタンのタブナビゲーション

### スクリーンリーダー

- 現在の記事位置をアナウンス
- ログインプロンプトの目的を説明
- OAuthボタンを明確にラベル付け

### 視覚的アクセシビリティ

- 十分な色のコントラストを維持
- ダークモードをサポート（既に実装済み）
- すべてのサイズでテキストが読みやすいことを保証

## モバイルレスポンシブ

### タッチジェスチャー

- ナビゲーションのための上下スワイプをサポート
- ログインプロンプトを超えるオーバースクロールを防止
- スムーズなスクロールアニメーション

### レイアウト適応

- すべてのデバイスでフルスクリーンスライド
- レスポンシブなログインプロンプトカード
- 小さな画面用にバナーサイズを調整

### モバイルでのパフォーマンス

- モバイル用に画像サイズを最適化
- JavaScript実行を最小化
- 高速な初期ロード時間

## 将来の拡張

### アナリティクス統合

- プレビューエンゲージメント指標を追跡
- ログインプロンプトでのコンバージョン率を測定
- 異なるプレビュー長のA/Bテスト

### パーソナライゼーション

- リファラーに基づいて異なる記事を表示
- ログインプロンプトメッセージをカスタマイズ
- ユーザー行動に基づいてプレビュー長を適応

### ソーシャルプルーフ

- ユーザー数や推薦文を表示
- プレビューでトレンド記事を表示
- 人気機能をハイライト

### プログレッシブディスクロージャー

- ハードストップの代わりに3記事後にコンテンツをぼかす
- 3番目の記事に段階的なフェード効果
- 4番目の記事コンテンツのティーザー
